<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Aruba Iot Websocket Server</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/3/w3.css">
<link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-blue-grey.css">
<link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<!-- Bootstrap -->
<!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
<!-- jQuery library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!-- Latest compiled JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

<style>
html,body,h1,h2,h3,h4,h5 {font-family: "Open Sans", sans-serif}
</style>

</head>


<script type="text/javascript">

  // ----- Global value
  var g_server = {
    "ip_address":"",
    "tcp_port":"8081",
    "api_key":"123",
    
    "url":"",
    "ws_url":"",
    "cnx_status":false,
    
    "current_device_mac":"",
    
    "current_reporter_mac":"",
    
    "current_service_uuid":"",
    "current_char_uuid":"",
    
    "char_list" : null,
    
    "area_list" : ['server', 'server_disconnected', 'server_settings', 'device', 'reporter']
    };
  var g_socket = null;
  

  // ----- Actions to do at page load
  $(document).ready(function(){
  
    awss_debug_div_close();
        
    awss_device_change_to_disconnected('');
    awss_banner_message('');

    // ----- Get IP from window URL    
    g_server['ip_address'] = window.location.hostname;

    document.getElementById("server_ip").value = g_server['ip_address'];
    document.getElementById("server_tcp").value = g_server['tcp_port'];
    document.getElementById("server_apikey").value = g_server['api_key']; 

    awss_server_change_to_disconnected();

  });

  function awss_timestamp() {
    var d = new Date();
    var n = d.getHours()+':'+d.getMinutes()+':'+d.getSeconds();
    //alert('date:'+n);
    return(n);
  }

  function awss_log(p_log) {
    v_msg = '['+awss_timestamp()+']: '+p_log;    
    console.log(v_msg);
  }

  function awss_server_connect() {
  
    // ----- Check if already connected
    if (g_server['cnx_status'] == true) {
      return;
    }
    
    // ----- Reset any banner message
    awss_banner_message('');
  
    g_server['ip_address'] = document.getElementById("server_ip").value;
    g_server['tcp_port'] = document.getElementById("server_tcp").value;
    g_server['api_key'] = document.getElementById("server_apikey").value;
    
    g_server['url'] = "http://"+g_server['ip_address']+":"+g_server['tcp_port']+"/api";
    g_server['ws_url'] = "ws://"+g_server['ip_address']+":"+g_server['tcp_port']+"/api";
    
    g_server['char_list'] = new Array();
    
    g_socket = new WebSocket(g_server['ws_url']);

    g_socket.onopen = function(e) {
      awss_server_change_to_connected();
    };
    
    g_socket.onmessage = function(event) {
      var val = event.data;

        try {
          var obj = JSON.parse(val);
        } catch (err) { alert('Error while parsing JSON result : '+val); return; }
        
        // ----- Logs
        if (obj.from_event == 'notification') {
          v_msg = obj.from_event+'->'+obj.data.type+','+obj.status;
        }
        else if (obj.from_event == 'notification_add') {
          v_msg = obj.from_event+'->'+obj.data.type+','+obj.status;
        }
        else {
          v_msg = obj.from_event+','+obj.status;
        }        
        awss_log(v_msg);

        if ((obj.from_event) && (obj.from_event == 'ble_connect') && (obj.status)) {
          if (obj.status == 'success') {
            awss_device_change_to_connected(obj.data.device_mac);
          }
          else {
            awss_device_change_to_disconnected(obj.data.device_mac);
          }
          // Nothing to do yet ?
        }
        else if ((obj.from_event) && (obj.from_event == 'ble_disconnect') && (obj.status)) {
          if (obj.status == 'success') {
            //alert('Received ble_disconnect for :'+obj.data.device_mac);
            awss_device_change_to_disconnected(obj.data.device_mac);
          }
          else {
              //alert('Received device status: '+obj.status+' for :'+obj.data.device_mac);
          }
        }
        else if ((obj.from_event) && (obj.from_event == 'ble_discover') && (obj.status)) {
          if (obj.status == 'success') {
            //alert('Received ble_discover for :'+obj.data.device_mac);
            if (g_server['current_device_mac'] == obj.data.device_mac) {
              awss_device_open(g_server['current_device_mac']);
            }
          }
          else {
              //alert('Received device status: '+obj.status+' for :'+obj.data.device_mac);
          }
        }
        else if ((obj.from_event) && (obj.from_event == 'device_list') && (obj.data.devices)) {
          awss_device_list_display(obj.data.devices);
        }
        else if ((obj.from_event) && (obj.from_event == 'reporter_list') && (obj.data.reporters)) {
          awss_reporter_list_display(obj.data.reporters);
        }
        else if ((obj.from_event) && (obj.from_event == 'device_info') && (obj.data)) {
          awss_device_display(obj.data);
        }
        else if ((obj.from_event) && (obj.from_event == 'websocket_info') && (obj.data)) {
          awss_server_info_update(obj.data);
        }
        else if ((obj.from_event) && (obj.from_event == 'reporter_info') && (obj.data)) {
          awss_reporter_display(obj.data);
        }
        else if ((obj.from_event) && (obj.from_event == 'include_mode') && (obj.status == 'success') ) {
          // Nothing to do ... may be log message
          if (typeof obj.data.state !== 'undefined') {
            awss_server_change_include_mode(obj.data.state);
          }
        }
        else if ((obj.from_event) && (obj.from_event == 'ble_read') && (obj.status == 'initiated') ) {
          // Nothing to do ... may be log message
        }
        else if ((obj.from_event) && (obj.from_event == 'ble_read') && (obj.status == 'success') ) {
          // For now, just releoad all the device
          // TBC : to  be optimized, update only the value ?
          if ((obj.data.device_mac) && (obj.data.device_mac == g_server['current_device_mac']) ) {
            awss_api_device_info(g_server['current_device_mac']);
          }
        }
        else if ((obj.from_event) && (obj.from_event == 'ble_read_multiple') && (obj.status == 'initiated') ) {
          // Nothing to do ... may be log message
        }
        else if ((obj.from_event) && (obj.from_event == 'ble_read_multiple') && (obj.status == 'success') ) {
          // For now, just releoad all the device
          // TBC : to  be optimized, update only the value ?
          if ((obj.data.device_mac) && (obj.data.device_mac == g_server['current_device_mac']) ) {
            awss_api_device_info(g_server['current_device_mac']);
          }
        }
        else if ((obj.from_event) && (obj.from_event == 'ble_notify') && (obj.status == 'initiated') ) {
          // TBC : update display
        }
        else if ((obj.from_event) && (obj.from_event == 'ble_notify') && (obj.status == 'starting') ) {
          // TBC : update display
        }
        else if ((obj.from_event) && (obj.from_event == 'ble_notify') && (obj.status == 'success') ) {
          awss_modal_new_value(obj.data);
        }
        else if ((obj.from_event) && (obj.from_event == 'notification_add')) {
          if (obj.status == 'success') {
          }
          else {
          }
        }
        else if ((obj.from_event) && (obj.from_event == 'notification') && (obj.status == 'success') ) {
          if (obj.data.type == 'device_status') {
            if (obj.data.status == 'connected')
              awss_device_change_to_connected(obj.data.device_mac);
            else if (obj.data.status == 'disconnected') {
              awss_device_change_to_disconnected(obj.data.device_mac);
            }
            else {
              awss_log('Received unexpected device status: '+obj.data.status+' for :'+obj.data.device_mac);
            }
          }
          
          else if (obj.data.type == 'reporter_status') {
            if (obj.data.status == 'active') {
              awss_reporter_change_to_actif('');
            }
            else if (obj.data.status == 'inactive') {
              awss_reporter_change_to_inactif('');
            }
            else {
              awss_log('Received unexpected reporter status: '+obj.data.status+' for :'+obj.data.device_mac);
            }
          }
          
        }
        else {
          awss_log('Received unexpected data from server: '+val);
        }
    };
    
    g_socket.onclose = function(event) {
      if (event.wasClean) {
        //alert(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
        awss_banner_message(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
      } else {
        // e.g. server process killed or network down
        // event.code is usually 1006 in this case
        //alert('[close] Connection died');
        awss_banner_message('[close] Connection died');
      }

      awss_server_change_to_disconnected();
    };
    
    g_socket.onerror = function(error) {
      //alert(`[error] ${error.message}`);
      awss_banner_message('Fail to connect to websocket server.');
      awss_server_change_to_disconnected();
    };

  }
  
  function awss_area_open(p_area) {
    if (!g_server['cnx_status']) {
      p_area='server_disconnected';
    }
    // ----- Close all and one the one 
    if (g_server['area_list'].includes(p_area)) {
      g_server['area_list'].forEach(function(p_item) {
        if (p_item == p_area) $('#grid_'+p_item).show();
        else $('#grid_'+p_item).hide();
      });
    }        
  }
  /*
  function awss_area_close(p_area) {
    if (g_server['area_list'].includes(p_area)) {
      $('#grid_'+p_area).hide();
    }        
  }
  */
  
  function awss_server_disconnect() {
    if ((g_server['cnx_status']) || (g_socket != null)) {
      g_socket.close(1000, "Bye bye");
    }
     
    awss_server_change_to_disconnected();  
  }
    
  function awss_server_change_to_connected() {
      g_server['cnx_status'] = true;
      
      $('#server_cnx_ok').show();
      $('#server_cnx_nok').hide();
  
      $('#bt_cnx').hide();
      $('#bt_dcnx').show();
  
    awss_area_open('server');
      
    $('#div_include_mode').show();
    $('#div_actions').show();
    
    // ----- Load websocket infos
    awss_api_server_info();
    
    // ----- Register to reporter_status
    awss_api_reporter_status_notify('');
  }
  
  function awss_server_change_to_disconnected() {
      awss_area_open('server_disconnected');

      g_server['cnx_status'] = false;
      
      $('#server_cnx_ok').hide();
      $('#server_cnx_nok').show();
      
      // TBC : should read the value from websocket config ... when available
      awss_server_change_include_mode(0);      

      $('#bt_cnx').show();
      $('#bt_dcnx').hide();
  
    
    $('#div_include_mode').hide();
    $('#div_actions').hide();
    
    // ----- Reset some lists
    document.getElementById("tbody_device_list").innerHTML = '';
  }
    
  
  function awss_server_info_update(p_data) {
  
    document.getElementById("span_nb_reporters").innerHTML = p_data.websocket.reporters_nb;
    document.getElementById("span_nb_devices").innerHTML = p_data.websocket.devices_nb;
    
    awss_server_change_include_mode(p_data.websocket.include_mode);

    document.getElementById("debug_text").innerHTML = JSON.stringify(p_data);
    
    document.getElementById("server_sett_ip").innerHTML = p_data.websocket.ip_address;
    document.getElementById("server_sett_tcp").innerHTML = p_data.websocket.tcp_port;
    document.getElementById("server_version").innerHTML = p_data.websocket.aruba_ws_version;
  
    /*var d = new Date(p_data.websocket.up_time);
    var n = d.getHours()+':'+d.getMinutes()+':'+d.getSeconds();
    document.getElementById("server_uptime").innerHTML = d.getDateString();
    */
    document.getElementById("server_uptime").innerHTML = p_data.websocket.up_time;


    document.getElementById("server_presence_timeout").value = p_data.websocket.presence_timeout;
    document.getElementById("server_presence_min_rssi").value = p_data.websocket.presence_min_rssi;
    document.getElementById("server_presence_histeresis").value = p_data.websocket.presence_rssi_hysteresis;
    document.getElementById("server_nearest_ap_timeout").value = p_data.websocket.nearest_ap_timeout;
    document.getElementById("server_nearest_ap_min_rssi").value = p_data.websocket.nearest_ap_min_rssi;
    document.getElementById("server_nearest_ap_histeresis").value = p_data.websocket.nearest_ap_hysteresis;
    document.getElementById("server_telemetry_max_timestamp").value = p_data.websocket.telemetry_max_timestamp;
    document.getElementById("server_access_token").value = p_data.websocket.access_token;
    document.getElementById("server_allow_list").value = '';
    
  
    // ----- Display websocket cnx list
    document.getElementById("tbody_websocket_cnx_list").innerHTML = '<tr><td>No connection</td></tr>';
    if (p_data.websocket.connections_list) {
      document.getElementById("tbody_websocket_cnx_list").innerHTML = '<tr><td><b>Id</b></td><td><b>Type</b></td><td><b>Remote IP</b></td></tr>';
      var v_list = p_data.websocket.connections_list;
      var v_count = 0;
      for (i in v_list) {
        var v_html = '';
        v_html += '<td>';
        v_html += ''+v_list[i].id+'';
        v_html += '</td>';
        v_html += '<td>';
        v_html += ''+v_list[i].type+'';
        v_html += '</td>';
        v_html += '<td>';
        v_html += ''+v_list[i].remote_ip+'';
        v_html += '</td>';
        v_count++;
  
        document.getElementById("tbody_websocket_cnx_list").innerHTML += '<tr>'+v_html+'</tr>';
      }
    }
    
    
    // ----- Display extension info
    document.getElementById("server_extension").innerHTML = 'No';
    if ((p_data.websocket.extension) && (p_data.websocket.extension.name)) {
      document.getElementById("server_extension").innerHTML = p_data.websocket.extension.name;
    }
    
    // ----- Display extension info
    document.getElementById("tbody_srv_notifications").innerHTML = '<tr><td>No registered notification</td></tr>';
    if (p_data.websocket.notification_queue) {
      document.getElementById("tbody_srv_notifications").innerHTML = '<tr><td><b>Id</b></td><td><b>Type</b></td><td><b>Callback Type</b></td><td><b>Callback Id</b></td><td><b>Timestamp</b></td></tr>';
      var v_list = p_data.websocket.notification_queue;
      var v_count = 0;
      for (i in v_list) {
        var v_html = '';
        v_html += '<td>';
        v_html += ''+v_list[i].notification_id+'';
        v_html += '</td>';
        v_html += '<td>';
        v_html += ''+v_list[i].notification_type+'';
        v_html += '</td>';
        v_html += '<td>';
        v_html += ''+v_list[i].cb_type+'';
        v_html += '</td>';
        v_html += '<td>';
        v_html += ''+v_list[i].cb_id+'';
        v_html += '</td>';
        v_html += '<td>';
        v_html += ''+v_list[i].timestamp+'';
        v_html += '</td>';
        v_count++;
  
        document.getElementById("tbody_srv_notifications").innerHTML += '<tr>'+v_html+'</tr>';
      }
    }
    
  /*
{"websocket":{"aruba_ws_version":"1.4-beta","ip_address":"0.0.0.0","tcp_port":"8081","up_time":"2022-02-25 11:21:20",
"presence_timeout":90,"presence_min_rssi":-90,"presence_rssi_hysteresis":5,"nearest_ap_hysteresis":5,"nearest_ap_timeout":90,
"nearest_ap_min_rssi":-90,"reporters_allow_list":"","access_token":"","telemetry_max_timestamp":60,"reporters_nb":1,
"devices_nb":0,"include_mode":1,"include_device_count":0,"device_type_allow_list":"enoceanSwitch,enoceanSensor,unclassified",
"include_unclassified_with_local":0,"include_unclassified_with_mac":0,"include_unclassified_mac_prefix":"","include_unclassified_max_devices":"10",
"stats":{"payload_data":12377,"raw_data":15792},"gatt_queue_nb":0,
"connections_list":{"192.168.22.6:59057":{"id":"192.168.22.6:59057","type":"telemetry","remote_ip":"192.168.22.6"},"192.168.22.6:59058":{"id":"192.168.22.6:59058","type":"serial","remote_ip":"192.168.22.6"},"192.168.22.148:49558":{"id":"192.168.22.148:49558","type":"ws_api","remote_ip":"192.168.22.148"}},
"extension":{"status":"no","name":""},
"notification_queue":{"6218bbe1a8218":{"notification_id":"6218bbe1a8218","notification_type":"reporter_status","cb_type":"ws_api","cb_id":"192.168.22.148:49558","timestamp":1645788129,"data":[]}}}}

  */
  }
  
  function awss_api_server_info() {
  
    var v_data = {
      "api_version":"1.0",
      "api_key":g_server['api_key'],
      "event":{
        "name":"websocket_info",
        "data": {
          "level":"extended"
        }
      }
    };
    
    // ----- Send request in websocket connection
    g_socket.send(JSON.stringify(v_data));
    
  }
      
  function awss_debug_div_open() {
    if (g_server['cnx_status']) {
      $('#grid_debug').show();   
      awss_api_debug_info();
    }
  }
  
  function awss_debug_div_close() {
    $('#grid_debug').hide();
  
  }
  
  function awss_server_div_open() {
    awss_area_open('server');
    
  }
  
  function awss_server_change_include_mode(p_mode) {
    if (p_mode == 1) {
      $('#include_mode_on').show();
      $('#start_include_bt').hide();
      $('#stop_include_bt').show();
      $('#awss_include_params').hide();
      
      
      
      
    }
    else {
      $('#include_mode_on').hide();
      $('#start_include_bt').show();
      $('#stop_include_bt').hide();

      $('#awss_include_params').show();
    }

    return;
  }

      
  function awss_server_settings_apply() {
    alert('Not yet implemented');
  }      
  
  function awss_api_include_mode(p_include_mode) {
  
    var unclassified_selected = 0;
    var array_type = []
    var checkboxes = document.querySelectorAll('input[name=device_type]:checked')
    for (var i = 0; i < checkboxes.length; i++) {
      array_type.push(checkboxes[i].value);
      if (checkboxes[i].value == 'unclassified') {
        unclassified_selected = 1;
      }
    }
    v_type = array_type.toString();
    
    v_with_local = 0;
    v_mac_prefix = '';
    v_max = 0;
    if (unclassified_selected) {
      if ($('#include_with_local').is(":checked")) {
        v_with_local = 1;
      }
    }


    v_mac_prefix = document.getElementById("include_mac_prefix").value;
    v_with_mac = 0;
    if (v_mac_prefix != '') {
      v_with_mac = 1;
    }
    v_max = document.getElementById("include_max").value;



    var v_data = {
      "api_version":"1.0",
      "api_key":g_server['api_key'],
      "event":{
          "name":"include_mode",
          "data": {
            "state":p_include_mode,
            "type":v_type,
            "unclassified_with_local":v_with_local,
            "unclassified_with_mac":v_with_mac,
            "unclassified_mac_prefix":v_mac_prefix,
            "unclassified_max_devices":v_max
          }
      }
    };

/*
    var v_data = {
      "api_version":"1.0",
      "api_key":g_server['api_key'],
      "event":{
          "name":"include_mode",
          "data": {
            "state":p_include_mode,
            "type":"unclassified,enoceanSensor,enoceanSwitch,arubaTag,arubaBeacon",
            "unclassified_with_local":"",
            "unclassified_with_mac":0,
            "unclassified_mac_prefix":"",
            "unclassified_max_devices":10
          }
      }
    };
    */

    // ----- Send request in websocket connection
    g_socket.send(JSON.stringify(v_data));

    return;
  }

  function awss_device_char_read(p_mac, p_service, p_char) {
  //alert('look for :'+p_mac+','+p_service+','+p_char);
  
    var v_data = {
      "api_version":"1.0",
      "api_key":g_server['api_key'],
      "event":{
        "name":"ble_read",
        "data": {
        "device_mac":p_mac,
          "service_uuid":p_service,
          "char_uuid":p_char
        }
      }
    };

    // ----- Send request in websocket connection
    g_socket.send(JSON.stringify(v_data));

    return;  
  }
  
  function awss_device_char_read_select(p_mac, p_service, p_char, p_select) {
    //alert('look for :'+p_mac+','+p_service+','+p_char+','+p_select);
    v_id = p_mac+'+'+p_service+'+'+p_char;
    
  v_index = g_server['char_list'].findIndex(function(p_item) {
    //alert('compare :'+p_item.id+' with '+this);
    if (p_item == this) return true; else return false;
  }, v_id);
  //alert('index:'+v_index);
  
   // ----- Look if selected
   if (p_select) {
     if (v_index == -1) {
       //alert('not in, add');
       g_server['char_list'].push(v_id);
     }
     else {
       // nothing to do
       //alert(' already in');
     }
   }
   // Look if deselected
   else {
     if (v_index == -1) {
       // nothing to do
       //alert('already not in');
     }
     else {
       //alert('in, remove');
       g_server['char_list'].splice(v_index,1);
     }
   }


    return;  
  }
  
  function awss_device_char_read_list(p_mac, p_service, p_char) {
  //alert('look for :'+p_mac+','+p_service+','+p_char);
  
    if (g_server['char_list'].length == 0) {
      return;
    }
    
    var v_list = new Array();
    var p_mac='';
    var v_val = '';
    var j=0;
    for (var i = 0; i < g_server['char_list'].length; i++) {
      v_val = v_val+' // '+g_server['char_list'][i];
      v_item = g_server['char_list'][i].split('+');
      if (p_mac == '') {
      p_mac = v_item[0];
      }
      else {
        // All must be for same mac@
        if (p_mac != v_item[0]) {
          return;
        }
      }
      v_list[j] = new Array();
      var v_obj = {'service_uuid': v_item[1], 'char_uuid':v_item[2]};
      v_list[j]=v_obj;
      j++;
    }
    //alert(v_val);
  
    var v_data = {
      "api_version":"1.0",
      "api_key":g_server['api_key'],
      "event":{
        "name":"ble_read_multiple",
        "data": {
        "device_mac":p_mac,
          "char_list":v_list
        }
      }
    };

    // ----- Send request in websocket connection
    g_socket.send(JSON.stringify(v_data));

    return;  
  }
  
  function awss_device_char_notify(p_mac, p_service, p_char, p_mode) {
  //alert('look for :'+p_mac+','+p_service+','+p_char);
  
    g_server['current_device_mac'] = p_mac;
    if (p_mode == 1) {
      g_server['current_service_uuid'] = p_service;
      g_server['current_char_uuid'] = p_char;
    }
    else {
      g_server['current_service_uuid'] = "";
      g_server['current_char_uuid'] = "";
    }

    awss_modal_open();
    
    var v_data = {
      "api_version":"1.0",
      "api_key":g_server['api_key'],
      "event":{
        "name":"ble_notify",
        "data": {
          "device_mac":p_mac,
          "service_uuid":p_service,
          "char_uuid":p_char,
          "timeout":60,
          "mode":p_mode
        }
      }
    };

    // ----- Send request in websocket connection
    g_socket.send(JSON.stringify(v_data));

    return;  
  }


  function awss_device_change_to_connected(p_mac) {
    if (p_mac != g_server['current_device_mac']) {
      return;
    }
        
    $('#device_cnx_ok').show();
    
    $('#bt_ble_cnx').hide(); 
    $('#bt_ble_discover').hide(); 
    $('#bt_ble_dcnx').show(); 
    
  }
  
  function awss_device_change_to_disconnected(p_mac) {
    // if mac empty for disconnect
    if ((p_mac != g_server['current_device_mac']) && (p_mac != '')) {
      return;
    }
    
    $('#device_cnx_ok').hide();
    $('#bt_ble_cnx').show(); 
    $('#bt_ble_discover').show(); 
    $('#bt_ble_dcnx').hide(); 
  }
  
  function awss_api_device_info(p_mac) {
  
    var v_data = {
      "api_version":"1.0",
      "api_key":g_server['api_key'],
      "event":{
        "name":"device_info",
        "data": {
          "device_mac":p_mac
        }
      }
    };
    
    // ----- Send request in websocket connection
    g_socket.send(JSON.stringify(v_data));
    
  }
    
  function awss_api_device_notify(p_mac) {
  
    var v_data = {
      "api_version":"1.0",
      "api_key":g_server['api_key'],
      "event":{
        "name":"notification_add",
        "data": {
          "type":"device_status",
          "device_mac":p_mac
        }
      }
    };
    
    // ----- Send request in websocket connection
    g_socket.send(JSON.stringify(v_data));
    
  }
    
  function awss_api_device_notify_stop(p_mac) {
  
    var v_data = {
      "api_version":"1.0",
      "api_key":g_server['api_key'],
      "event":{
        "name":"notification_remove",
        "data": {
          "type":"device_status",
          "device_mac":p_mac
        }
      }
    };
    
    // ----- Send request in websocket connection
    g_socket.send(JSON.stringify(v_data));
    
  }
    
  function awss_device_open(p_mac) {
  
    // ----- Look for changing device
    if ((g_server['current_device_mac'] != p_mac) && (g_server['current_device_mac'] != '')) {
      awss_api_device_notify_stop(g_server['current_device_mac']);
    }
    
    g_server['current_device_mac'] = p_mac;
    
    awss_device_change_to_disconnected(p_mac);
     
    awss_api_device_info(p_mac);
   
    awss_api_device_notify(p_mac);
   
    return;
  }
    
  function awss_device_display(p_data) {
  
    if (p_data.device.connect_status == 'connected') {
      awss_device_change_to_connected(p_data.device.mac);
    }
    else {
      awss_device_change_to_disconnected(p_data.device.mac);
    }
    
    g_server['char_list'] = new Array();
        
    document.getElementById("device_name").innerHTML = p_data.device.name;
    document.getElementById("device_mac").innerHTML = p_data.device.mac;
    document.getElementById("device_classname").innerHTML = p_data.device.classname;
    document.getElementById("device_vendor_id").innerHTML = p_data.device.vendor_id;
    document.getElementById("device_model_id").innerHTML = p_data.device.model_id;
    document.getElementById("device_nearest_ap_mac").innerHTML = p_data.device.nearest_ap_mac;
    document.getElementById("device_vendor_name").innerHTML = p_data.device.vendor_name;
    document.getElementById("device_local_name").innerHTML = p_data.device.local_name;
    document.getElementById("device_model").innerHTML = p_data.device.model;
    document.getElementById("device_rssi").innerHTML = p_data.device.rssi;
    if ((p_data.device.presence) && (p_data.device.presence ==1 )) {
      document.getElementById("device_status").innerHTML = '<button type="button" class="btn btn-success btn-xs" >Present</button>';
    }
    else {
      document.getElementById("device_status").innerHTML = '<button type="button" class="btn btn-danger btn-xs" >Missing</button>';
    }

    document.getElementById("tbody_telemetry_list").innerHTML = '';
    v_count_top_1 = 0;
    
    if (p_data.device.battery) {
      var v_html = '';
      v_html += '<td>';
      v_html += '<span class="bt_modal_doc" >';
      v_html += '<label class="w3-text-black" style="cursor: pointer;">Battery : '+p_data.device.battery.value+' %</label>';
      v_html += '</span>';
      v_html += '</td>';
      v_count_top_1++;
      document.getElementById("tbody_telemetry_list").innerHTML += '<tr>'+v_html+'</tr>';
    }
    
    for (i in p_data.device.telemetry_values) {
      var v_html = '';

      v_html += '<td>';
      v_html += '<span class="bt_modal_doc" >';
      v_html += '<label class="w3-text-black" style="cursor: pointer;">'+p_data.device.telemetry_values[i].name+' : '+p_data.device.telemetry_values[i].value+'</label>';
      v_html += '</span>';
      v_html += '</td>';
      v_count_top_1++;

      document.getElementById("tbody_telemetry_list").innerHTML += '<tr>'+v_html+'</tr>';
    }
    document.getElementById("telemetry_list_nb").innerHTML = v_count_top_1;

    $('#div_telemetry_list').show();

    document.getElementById("tbody_char_list").innerHTML = '';
    v_count_top_1 = 0;
    for (i in p_data.device.services) {
      var v_html = '';

      v_html += '<td>';
      v_html += '<span class="bt_modal_doc" >';
      v_html += '<label class="w3-text-black" style="cursor: pointer;">Service '+p_data.device.services[i].uuid+'</label>';
      v_html += '</span>';
      v_html += '</td>';
      v_count_top_1++;

      document.getElementById("tbody_char_list").innerHTML += '<tr>'+v_html+'</tr>';

      for (j in p_data.device.services[i].char_list) {
        var v_html = '';
        
        var v_str = '';
        if (p_data.device.services[i].char_list[j].value_string != '') {
          v_str = ' ('+p_data.device.services[i].char_list[j].value_string+')';
        }
        
        var v_types = p_data.device.services[i].char_list[j].types.split(",");
  
        v_html += '<td>';
        v_html += '<span class="bt_modal_doc" >';
        v_html += '<label class="w3-text-black" style="cursor: pointer;">&nbsp;&nbsp; '+p_data.device.services[i].char_list[j].uuid+' ('+p_data.device.services[i].char_list[j].types+') : '+p_data.device.services[i].char_list[j].value+v_str+'</label>';
        //v_html += '<span class="w3-right"><label class="w3-text-black" style="cursor: pointer;" onclick="awss_device_char_read(\''+p_data.device.mac+'\', \''+p_data.device.services[i].uuid+'\', \''+p_data.device.services[i].char_list[j].uuid+'\');">&nbsp;&nbsp; read</label></span>';
        v_html += '<span class="w3-right">';
        if (v_types.includes('read')) {
          v_html += '<input type="checkbox" onchange="awss_device_char_read_select(\''+p_data.device.mac+'\', \''+p_data.device.services[i].uuid+'\', \''+p_data.device.services[i].char_list[j].uuid+'\', this.checked);"> ';
          v_html += '<button type="button" class="btn btn-xs" onclick="awss_device_char_read(\''+p_data.device.mac+'\', \''+p_data.device.services[i].uuid+'\', \''+p_data.device.services[i].char_list[j].uuid+'\');">read</button>';
        } 
        /*
        Removed : this API is not anymore available until further analysis
        if (v_types.includes('notify')) {
          v_html += '&nbsp;<button type="button" class="btn btn-xs" onclick="awss_device_char_notify(\''+p_data.device.mac+'\', \''+p_data.device.services[i].uuid+'\', \''+p_data.device.services[i].char_list[j].uuid+'\', 1);">notify</button>';
        } 
        */
        v_html += '</span>';
        v_html += '</span>';
        v_html += '</td>';
        v_count_top_1++;
          
        document.getElementById("tbody_char_list").innerHTML += '<tr>'+v_html+'</tr>';
      }

    }
    document.getElementById("char_list_nb").innerHTML = v_count_top_1;

    $('#div_char_list').show();

    return;
  }
  
  function awss_device_list_div_open() {
  
    if (!g_server['cnx_status']) {
      awss_banner_message('Need to connect before accessing device list !');
      return;
    }

    awss_api_device_list();
    
    awss_area_open('device');
    
    $('#div_device_list').show();
  }
  
  function awss_api_device_list() {

    var v_data = {
      "api_version":"1.0",
      "api_key":g_server['api_key'],
      "event":{
        "name":"device_list",
        "data": {
        "data":"192.168.22.156",
        "data_2":"value_2"
        }
      }
    };
    
    // ----- Send request in websocket connection
    g_socket.send(JSON.stringify(v_data));
    
    return;
  }

  function awss_device_list_display(v_list) {

    document.getElementById("tbody_device_list").innerHTML = '';
    v_count_top_1 = 0;
    v_mac_default = '';
    for (i in v_list) {
      if (v_mac_default == '') {
        v_mac_default = v_list[i].mac;
      } 
      var v_html = '';
      
      var v_name = v_list[i].name;
      if (v_name == '') {
        var v_name = v_list[i].mac;
      }

      v_html += '<td>';

      if (v_list[i].presence == 1) {
        v_html += '<span class="w3-badge w3-green w3-medium" style="vertical-align: top;">&nbsp;</span>&nbsp;&nbsp;';
      }
      else {
        v_html += '<span class="w3-badge w3-red w3-medium" style="vertical-align: top;">&nbsp;</span>&nbsp;&nbsp;';
      }

      v_html += '<span class="bt_modal_doc" onClick="awss_device_open(\''+v_list[i].mac+'\');" >';
      v_html += '<label class="w3-text-black" style="cursor: pointer;">'+v_name+'</label>';
      v_html += '</span>';
      v_html += '</td>';
      v_count_top_1++;

      document.getElementById("tbody_device_list").innerHTML += '<tr>'+v_html+'</tr>';
    }
    document.getElementById("device_list_nb").innerHTML = v_count_top_1;
    document.getElementById("span_nb_devices").innerHTML = v_count_top_1;

    if (v_mac_default != '') {
      awss_device_open(v_mac_default);
    }

    return;
  }


  function awss_api_device_connect(p_mac, p_mode) {

    g_server['current_device_mac'] = p_mac;
    
    var v_event = 'ble_connect';
    if (p_mode != 1)
      v_event = 'ble_disconnect';

    var v_data = {
      "api_version":"1.0",
      "api_key":g_server['api_key'],
      "event":{
        "name":v_event,
        "data": {
        "device_mac":p_mac
        }
      }
    };

    // ----- Send request in websocket connection
    g_socket.send(JSON.stringify(v_data));

    return;
  }

  function awss_api_device_discover(p_mac) {

    g_server['current_device_mac'] = p_mac;
    
    var v_event = 'ble_discover';

    var v_data = {
      "api_version":"1.0",
      "api_key":g_server['api_key'],
      "event":{
        "name":v_event,
        "data": {
        "device_mac":p_mac
        }
      }
    };

    // ----- Send request in websocket connection
    g_socket.send(JSON.stringify(v_data));

    return;
  }

  function awss_reporter_div_open(p_mac) {
    awss_api_reporter_info(p_mac);
  }
  

  function awss_reporter_list_div_open(p_mac) {
    if (!g_server['cnx_status']) {
      awss_banner_message('Need to connect before accessing reporter list !');
      return;
    }

    awss_area_open('reporter');
        
    awss_api_reporter_list();
  }
  

  function awss_reporter_list_display(p_list) {

    document.getElementById("tbody_reporter_list").innerHTML = '';
    v_count_top_1 = 0;
    v_mac_default = '';
    for (i in p_list) {
      if (v_mac_default == '') {
        v_mac_default = p_list[i].mac;
      } 
      var v_html = '';
    
      v_html += '<td>';
      if (p_list[i].status == 'active') {
        v_html += '<span class="w3-badge w3-green w3-medium" style="vertical-align: top;">&nbsp;</span>&nbsp;&nbsp;';
      }
      else {
        v_html += '<span class="w3-badge w3-red w3-medium" style="vertical-align: top;">&nbsp;</span>&nbsp;&nbsp;';
      }
      
      v_html += '<span class="bt_modal_doc" onClick="awss_reporter_div_open(\''+p_list[i].mac+'\');" >';
      v_html += '<label class="w3-text-black" style="cursor: pointer;">'+p_list[i].name+'</label>';
      v_html += '</span>';
      v_html += '</td>';
      v_count_top_1++;
    
      document.getElementById("tbody_reporter_list").innerHTML += '<tr>'+v_html+'</tr>';
    }
    document.getElementById("reporter_list_nb").innerHTML = v_count_top_1;
    document.getElementById("span_nb_reporters").innerHTML = v_count_top_1;
    
    $('#div_reporter_list').show();
    
    if (v_mac_default != '') {
      awss_reporter_div_open(v_mac_default);
    }

    return;
  }

  function awss_reporter_change_to_actif(p_mac) {
    //if (p_mac != g_server['current_reporter_mac']) {
    //  return;
    //}    
    // ----- Reload all the reporters
    awss_api_reporter_list();
  }

  function awss_reporter_change_to_inactif(p_mac) {
    //if (p_mac != g_server['current_reporter_mac']) {
    //  return;
    //}    
    // ----- Reload all the reporters
    awss_api_reporter_list();
  }

  function awss_api_reporter_list() {

    awss_area_open('reporter');
    
    var v_data = {
      "api_version":"1.0",
      "api_key":g_server['api_key'],
      "event":{
        "name":"reporter_list",
        "data": {
        "data":"xxx",
        "data_2":"xxx"
        }
      }
    };

    // ----- Send request in websocket connection
    g_socket.send(JSON.stringify(v_data));

    return;
  }

  function awss_api_reporter_info(p_mac) {
  
    var v_data = {
      "api_version":"1.0",
      "api_key":g_server['api_key'],
      "event":{
        "name":"reporter_info",
        "data": {
          "reporter_mac":p_mac
        }
      }
    };
    
    // ----- Send request in websocket connection
    g_socket.send(JSON.stringify(v_data));
    
  }
   
  function awss_api_reporter_status_notify(p_mac) {
  
    var v_data = {
      "api_version":"1.0",
      "api_key":g_server['api_key'],
      "event":{
        "name":"notification_add",
        "data": {
          "type":"reporter_status",
          "device_mac":p_mac
        }
      }
    };
    
    // ----- Send request in websocket connection
    g_socket.send(JSON.stringify(v_data));
    
  }
    
  function awss_api_reporter_status_notify_stop(p_mac) {
  
    var v_data = {
      "api_version":"1.0",
      "api_key":g_server['api_key'],
      "event":{
        "name":"notification_remove",
        "data": {
          "type":"reporter_status",
          "device_mac":p_mac
        }
      }
    };
    
    // ----- Send request in websocket connection
    g_socket.send(JSON.stringify(v_data));
    
  }
        
  function awss_reporter_display(p_data) {
  
    var v_html = '';
    if (p_data.reporter.status == 'active') {
      v_html = '<button type="button" class="btn btn-success btn-xs" >Active</button>';
      document.getElementById("reporter_status").innerHTML = v_html;
      document.getElementById("reporter_uptime").innerHTML = p_data.reporter.uptime;
    }
    else {
      v_html = '<button type="button" class="btn btn-danger btn-xs" >Down</button>';
      document.getElementById("reporter_status").innerHTML = v_html;
      document.getElementById("reporter_uptime").innerHTML = '';
    }

    document.getElementById("reporter_name").innerHTML = p_data.reporter.name;
    document.getElementById("reporter_mac").innerHTML = p_data.reporter.mac;
    document.getElementById("reporter_remote_ip").innerHTML = p_data.reporter.remote_ip;
    document.getElementById("reporter_local_ip").innerHTML = p_data.reporter.local_ip;
    document.getElementById("reporter_hardware_type").innerHTML = p_data.reporter.hardware_type;
    document.getElementById("reporter_software_version").innerHTML = p_data.reporter.software_version;
    document.getElementById("reporter_software_build").innerHTML = p_data.reporter.software_build;
    
    if ((p_data.reporter.cnx_ble) && (p_data.reporter.cnx_ble != '')) {
      document.getElementById("ap_cnx_ble").innerHTML = '<button type="button" class="btn btn-success btn-xs" >Active</button> (id:'+p_data.reporter.cnx_ble+')';
    }
    else {
      document.getElementById("ap_cnx_ble").innerHTML = '<button type="button" class="btn btn-xs" >Inactive</button>';
    }
    if ((p_data.reporter.cnx_zigbee) && (p_data.reporter.cnx_zigbee != '')) {
      document.getElementById("ap_cnx_zigbee").innerHTML = '<button type="button" class="btn btn-success btn-xs" >Active</button> (id:'+p_data.reporter.cnx_zigbee+')';
    }
    else {
      document.getElementById("ap_cnx_zigbee").innerHTML = '<button type="button" class="btn btn-xs" >Inactive</button>';
    }
    if ((p_data.reporter.cnx_serial) && (p_data.reporter.cnx_serial != '')) {
      document.getElementById("ap_cnx_serial").innerHTML = '<button type="button" class="btn btn-success btn-xs" >Active</button> (id:'+p_data.reporter.cnx_serial+')';
    }
    else {
      document.getElementById("ap_cnx_serial").innerHTML = '<button type="button" class="btn btn-xs" >Inactive</button>';
    }
    if ((p_data.reporter.cnx_rtls) && (p_data.reporter.cnx_rtls != '')) {
      document.getElementById("ap_cnx_rtls").innerHTML = '<button type="button" class="btn btn-success btn-xs" >Active</button> (id:'+p_data.reporter.cnx_rtls+')';
    }
    else {
      document.getElementById("ap_cnx_rtls").innerHTML = '<button type="button" class="btn btn-xs" >Inactive</button>';
    }

    return;
  }
  

  function awss_onsubmit() {
    return(false);
  }


  function awss_banner_message(v_text) {
    document.getElementById("banner_msg_text").innerHTML = v_text;
    if (v_text == '') {
      $('#banner_msg_div').hide();
    }
    else {
      document.getElementById("banner_msg_text").innerHTML = v_text;
      $('#banner_msg_div').show();
    }
  }

  function awss_modal_open() {
  
    document.getElementById("awss_modal_value_list").innerHTML = '';
    
    $('#device_overview_modal').modal('show');


  }

  function awss_modal_close() {
  
    // ----- Send the stop api message
    awss_device_char_notify(g_server['current_device_mac'], g_server['current_service_uuid'], g_server['current_char_uuid'], 0);
    
    document.getElementById("awss_modal_value_list").innerHTML = '';
    
    $('#device_overview_modal').modal('hide');

  }

  function awss_modal_new_value(p_data) {
  
    var v_value = '';
    v_value = p_data.value;
    if (p_data.value_string)
      v_value += ' ('+p_data.value_string+')';
    v_value += '<br>';
 
    document.getElementById("awss_modal_value_list").innerHTML += v_value;

  }


  function awss_api_debug_info() {
  
    var v_data = {
      "api_version":"1.0",
      "api_key":g_server['api_key'],
      "event":{
        "name":"websocket_info",
        "data": {
          "level":"extended"
        }
      }
    };
    
    // ----- Send request in websocket connection
    g_socket.send(JSON.stringify(v_data));
    
  }
  
  
</script>


<body class="w3-theme-l5">

<div class="w3-top">
 <div class="w3-bar w3-theme-d2 w3-left-align w3-large">
  <a class="w3-bar-item w3-button w3-hide-medium w3-hide-large w3-right w3-padding-large w3-hover-white w3-large w3-theme-d2" href="javascript:void(0);" onclick="openNav()"><i class="fa fa-bars"></i></a>
  <a href="#" class="w3-bar-item w3-button w3-padding-large w3-theme-d4"><i class="fa fa-home w3-margin-right"></i> Aruba Iot Websocket Server</a>
  	

<a href="#" onClick="awss_server_div_open();" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">Dashboard</a>
   
  <div class="w3-dropdown-hover w3-button w3-hide-small w3-padding-large w3-hover-white">Devices
    <div class="w3-dropdown-content w3-card-4 w3-bar-block" style="width:300px">

            <a href="#" class="w3-bar-item w3-button" onClick="awss_device_list_div_open();">List</a>
	
    </div>
  </div>
  

  <div class="w3-dropdown-hover w3-button w3-hide-small w3-padding-large w3-hover-white">Reporters
    <div class="w3-dropdown-content w3-card-4 w3-bar-block" style="width:300px">

             <a href="#" class="w3-bar-item w3-button" onClick="awss_reporter_list_div_open();">List</a>
			    
	
    </div>
  </div>
  

  <div class="w3-dropdown-hover w3-button w3-hide-small w3-padding-large w3-hover-white">Server
    <div class="w3-dropdown-content w3-card-4 w3-bar-block" style="width:300px">

             <a href="#" class="w3-bar-item w3-button" onClick="awss_server_div_open();">Dashboard</a>
             <a href="#" class="w3-bar-item w3-button" onClick="awss_debug_div_open();">Debug</a>
			    
	
    </div>
  </div>
  

  <div class="w3-dropdown-hover w3-button w3-hide-small w3-right w3-padding-large w3-hover-white"><span class="glyphicon glyphicon-cog"></span>&nbsp;&nbsp; Settings &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    <div class="w3-dropdown-content w3-card-4 w3-bar-block" style="width:300px">
      <a href="#" class="w3-bar-item w3-button" onclick="awss_api_server_info(); awss_area_open('server_settings');">Settings</a>

      <a href="#" class="w3-bar-item w3-button" onClick="awss_server_disconnect();">Disconnect</a>
    </div>
  </div>

 </div>
</div>

<!-- Navbar on small screens -->
<div id="navDemo" class="w3-bar-block w3-theme-d2 w3-hide w3-hide-large w3-hide-medium w3-large">
  <a href="#" class="w3-bar-item w3-button w3-padding-large">Link 1</a>
  <a href="#" class="w3-bar-item w3-button w3-padding-large">Link 2</a>
  <a href="#" class="w3-bar-item w3-button w3-padding-large">Link 3</a>
  <a href="#" class="w3-bar-item w3-button w3-padding-large">My Profile</a>
</div>


<!-- Page Container -->
<div id="pce_page_container" class="w3-container w3-content" style="max-width:1600px;margin-top:80px">



<form id="main_form" action="#" method="post" autocomplete="off" class="w3-container" onsubmit="return(awss_onsubmit());">

  <!-- The Grid Banner -->
  <div class="w3-row" id="grid_banner">

    <!-- Left Column -->
    <div class="w3-col m12">

      <!-- Block --><!-- AWSS Banner -->
      <div class="w3-container w3-card-2 w3-white w3-round w3-margin" >
              <h4>
              <button type="button" class="btn btn-success btn-xs" id="server_cnx_ok">Connected</button> 
              <button type="button" class="btn btn-danger btn-xs" id="server_cnx_nok">Disconnected</button>
              <button type="button" class="btn btn-info btn-xs" id="include_mode_on">Include Mode is ON</button> 
              &nbsp;to Websocket Server
              
              
              <span class="w3-right">
              <span id="span_nb_reporters">0</span> Reporter(s) - <span id="span_nb_devices">0</span> Device(s)
              <span id="banner_msg_div">
              <button type="button" class="btn btn-warning btn-xs" id="server_cnx_nok">
              <span id="banner_msg_text"></span>
              &nbsp;<span class="glyphicon glyphicon-remove-sign" onclick="$('#banner_msg_div').hide();" style="cursor: pointer;"></span>
              </button>            
              &nbsp;
              </span>
              </span>
              </h4>
      </div>
      <!-- Block -->

    </div>
    <!-- End Left Column -->

  </div>
  <!-- End Row The Grid Banner -->










  <!-- The Grid Server Disconencted -->
  <div class="w3-row" id="grid_server_disconnected">

    <!-- Left Column -->
    <div class="w3-col m3">

&nbsp;

    </div>
    <!-- End Left Column -->

    <!-- begin central Column -->
    <div id="div_xxx" class="w3-col m6">


      <!-- Block --><!-- AWSS Server -->
      <div class="w3-container w3-card-2 w3-white w3-round w3-margin" style="min-height:180px;">
      
      
              <h2>Aruba Websocket Server</h2>

              <table class="table">
                  <tbody>
                    <tr>
                      <td>
              
        <h4><i>Server IP :&nbsp;&nbsp;</i>
          <input class="w3-border w3-round-large" type="text" id="server_ip" value="0.0.0.0">
        </h4>

        <h4><i>Server TCP Port :&nbsp;&nbsp;</i>
          <input class="w3-border w3-round-large" type="text" id="server_tcp" value="8081">
        </h4>

        <h4><i>API Key :&nbsp;&nbsp;</i>
          <input class="w3-border w3-round-large" type="text" id="server_apikey" value="123">
        </h4>
              
                      </td>
                    </tr>
                  </tbody>
              </table>

        <h4 class="w3-center">
          <button id="bt_cnx" class="w3-btn w3-blue  w3-round-large" onclick="awss_server_connect();">Connect</button>
          &nbsp;<button  id="bt_dcnx" class="w3-btn w3-blue  w3-round-large" onclick="awss_server_disconnect();">Disconnect</button>
        </h4>

        <br>&nbsp;<br>
      </div>
      <!-- Block -->

    </div>
    <!-- End central Column -->

    <!-- begin Right Column -->
    <div id="div_xxss" class="w3-col m3">

&nbsp;


    </div>
    <!-- End Right Column -->

  </div>
  <!-- End Row The Grid Server Disconnected -->














  <!-- The Grid Server Details -->
  <div class="w3-row" id="grid_server">

    <!-- Left Column -->
    <div class="w3-col m2">

&nbsp;


    </div>
    <!-- End Left Column -->

    <!-- begin central Column -->
    <div id="div_include_mode" class="w3-col m8">

      <!-- Block --><!-- AWSS Include Mode -->
      <div class="w3-container w3-card-2 w3-white w3-round w3-margin" style="min-height:180px;">

              <h2>Include Mode</h2>

              <table class="table">
                  <tbody>
                    <tr>
                      <td>
              
        <div id="awss_include_params">

        <h4>Device Types to include :&nbsp;&nbsp;</h4>
          
        <table class="table">
            <tbody>
              <tr>
                <td>
          <input type="checkbox"  name="device_type" value="arubaBeacon"><label >&nbsp;arubaBeacon</label><br>          
                </td><td>
          <input type="checkbox" name="device_type" value="arubaTag"><label >&nbsp; arubaTag</label><br>          
                </td><td>
          <input type="checkbox"  name="device_type" value="enoceanSwitch" checked ><label >&nbsp; enoceanSwitch</label><br>          
                </td><td>
          <input type="checkbox" name="device_type" value="enoceanSensor" checked ><label>&nbsp; enoceanSensor</label><br>                
                </td>
              </tr>
              <tr>
                <td>
          <input type="checkbox" name="device_type" value="zfTag"><label>&nbsp; zfTag</label><br>                 
                </td><td>
          <input type="checkbox" name="device_type" value="stanleyTag"><label>&nbsp; stanleyTag</label><br>                 
                </td><td>
          <input type="checkbox" name="device_type" value="virginBeacon"><label>&nbsp; virginBeacon</label><br>       
                </td><td>
          <input type="checkbox" name="device_type" value="abbSensor"><label>&nbsp; abbSensor</label><br>       
                </td>
              </tr>
              <tr>
                <td>
          <input type="checkbox" name="device_type" value="mysphera"><label>&nbsp; mysphera</label><br>       
                </td><td>
          <input type="checkbox" name="device_type" value="wiliot"><label>&nbsp; wiliot</label><br>       
                </td><td>
          <input type="checkbox" name="device_type" value="ZSD"><label>&nbsp; ZSD</label><br>       
                </td><td>
          <input type="checkbox" name="device_type" value="onity"><label>&nbsp; onity</label><br>       
                </td>
              </tr>
              <tr>
                <td>
          <input type="checkbox" name="device_type" value="minew"><label>&nbsp; minew</label><br>       
                </td><td>
          <input type="checkbox" name="device_type" value="google"><label>&nbsp; google</label><br>       
                </td><td>
          <input type="checkbox" name="device_type" value="polestar"><label>&nbsp; polestar</label><br>       
                </td><td>
          <input type="checkbox" name="device_type" value="blyott"><label>&nbsp; blyott</label><br>       
                </td>
              </tr>
              <tr>
                <td>
          <input type="checkbox" name="device_type" value="diract"><label>&nbsp; diract</label><br>       
                </td><td>
          <input type="checkbox" name="device_type" value="gwahygiene"><label>&nbsp; gwahygiene</label><br>                        
                </td><td>
                </td><td>
                </td>
              </tr>
              <tr>
                <td colspan="5">
        
          <input type="checkbox" name="device_type" value="unclassified" checked ><label >&nbsp; unclassified</label><br>          
         
          <blockquote>
            <input type="checkbox" id="include_with_local" value="1">
            <span > only unclassified devices with local info</span>   
            <br>
            <input type="checkbox" id="include_with_mac" value="1">
            <span> only unclassified devices with this MAC prefix :&nbsp;&nbsp;</span>
            <input class="w3-border w3-round-large" type="text" id="include_mac_prefix" value="">       
            <br>
            <span> Stop after &nbsp;</span>
            <input class="w3-border w3-round-large" type="text" id="include_max" value="10" style="width:50px;"> 
            <span> unclassified devices included.</span>      
          </blockquote>                

                </td>
              </tr>
            </tbody>
        </table>
                  
        </div>
        
        <h4 class="w3-center">
          <button class="w3-btn w3-blue  w3-round-large" id="start_include_bt" onclick="awss_api_include_mode(1);">Start Include Mode</button>
        </h4>

        <h4 class="w3-center">
          <button class="w3-btn w3-blue  w3-round-large" id="stop_include_bt" onclick="awss_api_include_mode(0);">Stop Include Mode</button>
        </h4>
              
                      </td>
                    </tr>
                  </tbody>
              </table>

      </div>
      <!-- Block -->

    </div>
    <!-- End central Column -->

    <!-- begin Right Column -->
    <div id="div_actions" class="w3-col m2">

      <!-- Block -->
      <div class="w3-container w3-card-2 w3-white w3-round w3-margin" style="min-height:180px;">

              <h2>Actions</h2>

              <table class="table">
                  <tbody>
                    <tr>
                      <td>
              
        <h4 class="w3-center">
          <button class="w3-btn w3-blue  w3-round-large" onclick="awss_device_list_div_open();">Device List</button>
        </h4>

        <h4 class="w3-center">
          <button class="w3-btn w3-blue  w3-round-large" onclick="awss_reporter_list_div_open();">Reporter List</button>
        </h4>

        <h4 class="w3-center">
          <button class="w3-btn w3-blue  w3-round-large" onclick="awss_modal_open(1);">Modal Test</button>
        </h4>
              
              
                      </td>
                    </tr>
                  </tbody>
              </table>

      </div>
      <!-- Block -->

      <!-- Block -->
      <div class="w3-container w3-card-2 w3-white w3-round w3-margin" style="min-height:180px;">

              <h2>Server</h2>

              <table class="table">
                  <tbody>
                    <tr>
                      <td>
              
        <h4 class="w3-center">
          <button class="w3-btn w3-blue  w3-round-large" onclick="awss_server_disconnect();">Disconnect</button>
        </h4>              
              
                      </td>
                    </tr>
                  </tbody>
              </table>

      </div>
      <!-- Block -->

    </div>
    <!-- End Right Column -->

  </div>
  <!-- End Row The Grid Server Dashboard -->













  <!-- The Grid Server Settings -->
  <div class="w3-row" id="grid_server_settings">

    <!-- Left Column -->
    <!-- End Left Column -->

    <!-- begin central Column -->
    <div id="div_server_central_settings" class="w3-col m10">

      <!-- Block -->
      <div class="w3-container w3-card-2 w3-white w3-round w3-margin" style="min-height:180px;">

              <h2>Server Info</h2>

              <table class="table">
                  <tbody>
                    <tr>
                      <td align="right">Version :</td><td><span id="server_version"></span></td>
                    </tr>
                    <tr>
                      <td align="right">IP Address :</td><td><span id="server_sett_ip"></span></td>
                    </tr>
                    <tr>
                      <td align="right">TCP Port :</td><td><span id="server_sett_tcp"></span></td>
                    </tr>
                    <tr>
                      <td align="right">Extension :</td><td><span id="server_extension"></span></td>
                    </tr>
                    <tr>
                      <td align="right">Up Time :</td><td><span id="server_uptime"></span></td>
                    </tr>
                  </tbody>
              </table>

      </div>
      <!-- Block -->

      <!-- Block -->
      <div class="w3-container w3-card-2 w3-white w3-round w3-margin" style="min-height:180px;">

              <h2>Server Settings</h2>

              <table class="table">
                  <tbody>
                    <tr>
                      <td align="right">Presence timeout :</td><td><input class="w3-border w3-round-large" type="text" id="server_presence_timeout" value=""> secondes</td>
                    </tr>
                    <tr>
                      <td align="right">Presence minimum RSSI :</td><td><input class="w3-border w3-round-large" type="text" id="server_presence_min_rssi" value=""> dBm</td>
                    </tr>
                    <tr>
                      <td align="right">Presence minimum Hysteresis :</td><td><input class="w3-border w3-round-large" type="text" id="server_presence_histeresis" value=""> dBm</td>
                    </tr>
                    <tr>
                      <td align="right">Nearest AP timeout :</td><td><input class="w3-border w3-round-large" type="text" id="server_nearest_ap_timeout" value=""> secondes</td>
                    </tr>
                    <tr>
                      <td align="right">Nearest AP minimum RSSI :</td><td><input class="w3-border w3-round-large" type="text" id="server_nearest_ap_min_rssi" value=""> dBm</td>
                    </tr>
                    <tr>
                      <td align="right">Nearest AP Hysteresis :</td><td><input class="w3-border w3-round-large" type="text" id="server_nearest_ap_histeresis" value=""> dBm</td>
                    </tr>
                    <tr>
                      <td align="right">Duplicate telemetry value max timestamp :</td><td><input class="w3-border w3-round-large" type="text" id="server_telemetry_max_timestamp" value=""> secondes</td>
                    </tr>
                    <tr>
                      <td align="right">Reporters access token :</td><td><input class="w3-border w3-round-large" type="text" id="server_access_token" value=""> </td>
                    </tr>
                    <tr>
                      <td align="right">Reporters allow list :</td><td><input class="w3-border w3-round-large" type="text" id="server_allow_list" value=""> </td>
                    </tr>


                    <tr>
                      <td colspan="2">
        <h4 class="w3-center">
          <button class="w3-btn w3-blue  w3-round-large" id="start_include_bt" onclick="awss_server_settings_apply();">Apply</button>
        </h4>              
                      </td>
                    </tr>
                  </tbody>
              </table>

      </div>
      <!-- Block -->

      <!-- Block -->
      <div class="w3-container w3-card-2 w3-white w3-round w3-margin" style="min-height:180px;">

              <h2>Websocket TCP Connections</h2>

              <table class="table">
                <tbody id="tbody_websocket_cnx_list">
                  <!-- Filled by Javascript -->
                </tbody>
              </table>

      </div>
      <!-- Block -->

      <!-- Block -->
      <div class="w3-container w3-card-2 w3-white w3-round w3-margin" style="min-height:180px;">
              <h2>Notifications Queue</h2>
              <table class="table">
                <tbody id="tbody_srv_notifications">
                  <!-- Filled by Javascript -->
                  <tr><td>No registered notifications</td></tr>
                </tbody>
              </table>
      </div>
      <!-- Block -->


    </div>
    <!-- End central Column -->

    <!-- begin Right Column -->
    <div id="div_actions" class="w3-col m2">

      <!-- Block -->
      <div class="w3-container w3-card-2 w3-white w3-round w3-margin" style="min-height:180px;">

              <h2>Actions</h2>

              <table class="table">
                  <tbody>
                    <tr>
                      <td>
              
        <h4 class="w3-center">
          <button class="w3-btn w3-blue  w3-round-large" onclick="awss_device_list_div_open();">Device List</button>
        </h4>

        <h4 class="w3-center">
          <button class="w3-btn w3-blue  w3-round-large" onclick="awss_reporter_list_div_open();">Reporter List</button>
        </h4>

        <h4 class="w3-center">
          <button class="w3-btn w3-blue  w3-round-large" onclick="awss_modal_open(1);">Modal Test</button>
        </h4>
              
              
                      </td>
                    </tr>
                  </tbody>
              </table>

      </div>
      <!-- Block -->

      <!-- Block -->
      <div class="w3-container w3-card-2 w3-white w3-round w3-margin" style="min-height:180px;">

              <h2>Server</h2>

              <table class="table">
                  <tbody>
                    <tr>
                      <td>
              
        <h4 class="w3-center">
          <button class="w3-btn w3-blue  w3-round-large" onclick="awss_server_disconnect();">Disconnect</button>
        </h4>              
              
                      </td>
                    </tr>
                  </tbody>
              </table>

      </div>
      <!-- Block -->

    </div>
    <!-- End Right Column -->

  </div>
  <!-- End Row The Grid Settings Details -->








  




  <!-- The Grid Device -->
  <div class="w3-row" id="grid_device">

    <!-- Left Column -->
    <div class="w3-col m4">

      <!-- Block -->
      <div id="div_device_list" class="w3-container w3-card-2 w3-white w3-round w3-margin">

        <h2><span class="glyphicon glyphicon-list-alt"></span>&nbsp;
        <span id="device_list_name">Devices List</span>&nbsp;<span class="w3-badge w3-green w3-medium" id="device_list_nb" style="vertical-align: top;">0</span>
        <span class="w3-right">
        <span class="glyphicon glyphicon-refresh" onclick="" style="cursor: pointer;"></span>&nbsp;
        </span>
        </h2>
        <input type="hidden" id="device_list_id" value="aruba">

        <div class="table-responsive" style="min-height:10px; max-height:400px;">
          <table class="table table-hover">
            <tbody id="tbody_device_list">
              <!-- Filled by Javascript -->
            </tbody>
          </table>
        </div>

      </div>
      <!-- Block -->



      <!-- Empty Block pour garder l'espace-->
      <div class="">
        &nbsp;
      </div>
      <!-- Block -->

    <!-- End Left Column -->
    </div>


    <!-- Begin Central Column -->
    <div class="w3-col m8">

      <!-- Block -->
      <div class="w3-container w3-card-2 w3-white w3-round w3-margin" >

        <h2>Device "<span id="device_name"></span>" 
        <span class="w3-right">
        <button type="button" class="btn btn-success btn-xs" id="device_cnx_ok">Connected</button>
        <span class="glyphicon glyphicon-refresh" onclick="awss_device_open(g_server['current_device_mac']);" style="cursor: pointer;"></span>&nbsp;
        </span>
        </h2>

        <table class="table">
            <tbody>
              <tr>             
        <td align="right" style="width:25%">MAC Address : </td><td><span id="device_mac"></span></td>
              </tr>
              <tr>             
        <td align="right">Vendor, Model : </td><td><span id="device_vendor_id"></span>, <span id="device_model_id"></span></td>
              </tr>
              <tr>             
        <td align="right" style="width:25%">Status : </td><td><span id="device_status"></span></td>
              </tr>
              <tr>             
        <td align="right">Active uptime : </td><td><span id="device_uptime"></span></td>
              </tr>
            </tbody>
        </table>

      </div>
      <!-- Block -->

      <!-- Block -->
      <div id="div_telemetry_list" class="w3-container w3-card-2 w3-white w3-round w3-margin">

        <h2><span class="glyphicon glyphicon-tag"></span>
        <span id="telemetry_list_name">Device Telemetry</span>&nbsp;<span class="w3-badge w3-green w3-medium" id="telemetry_list_nb" style="vertical-align: top;">0</span>
        </h2>
        <input type="hidden" id="telemetry_list_id" value="central">

        <div class="table-responsive table-condensed" style="min-height:10px; max-height:400px;">
          <table class="table table-hover">
            <tbody id="tbody_telemetry_list">
              <!-- Filled by Javascript -->
            </tbody>
          </table>
        </div>

      </div>
      <!-- Block -->


      <!-- Block -->
      <div id="div_char_list" class="w3-container w3-card-2 w3-white w3-round w3-margin">

        <h2><span class="glyphicon glyphicon-tag"></span>
        <span id="char_list_name">Device Characteristics</span>&nbsp;<span class="w3-badge w3-green w3-medium" id="char_list_nb" style="vertical-align: top;">0</span>        
        </h2>

        <h4 class="w3-center">
          <button class="w3-btn w3-blue  w3-round-large" id="bt_ble_discover" onclick="awss_api_device_discover(g_server['current_device_mac']);">Characteristics Discovery</button>
          &nbsp;&nbsp;  
          <button class="w3-btn w3-blue  w3-round-large" id="bt_ble_cnx" onclick="awss_api_device_connect(g_server['current_device_mac'], 1);">BLE Connect</button>
          &nbsp;&nbsp;  
          <button class="w3-btn w3-blue  w3-round-large" id="bt_ble_dcnx" onclick="awss_api_device_connect(g_server['current_device_mac'], 0);">BLE Disconnect</button>
        </h4>

        <div class="table-responsive table-condensed" style="min-height:10px; max-height:400px;">
        <h4><span class="w3-right"><button type="button" class="btn btn-xs" onclick="awss_device_char_read_list();">read multiple</button></span></h4>
        <br>
          <table class="table table-hover">
            <tbody id="tbody_char_list">
              <!-- Filled by Javascript -->
            </tbody>
          </table>
        </div>

      </div>
      <!-- Block -->

      <!-- Block -->
      <div class="w3-container w3-card-2 w3-white w3-round w3-margin" >

        <h3>Nearest Reporter</h3>
        <table class="table">
            <tbody>
              <tr>             
        <td align="right" style="width:25%">Nearest AP MAC : </td><td><span id="device_nearest_ap_mac"></span></td>
              </tr>
              <tr>             
        <td align="right">RSSI : </td><td><span id="device_rssi"></span></td>
              </tr>
            </tbody>
        </table>
        
      </div>
      <!-- Block -->

      <!-- Block -->
      <div class="w3-container w3-card-2 w3-white w3-round w3-margin" >

        <h3>Properties</h3>
        <table class="table">
            <tbody>
              <tr>             
        <td align="right" style="width:25%">Aruba Classname : </td><td><span id="device_classname"></span></td>
              </tr>
              <tr>             
        <td align="right">BLE Vendor Name : </td><td><span id="device_vendor_name"></span></td>
              </tr>
              <tr>             
        <td align="right">BLE Local Name : </td><td><span id="device_local_name"></span></td>
              </tr>
              <tr>             
        <td align="right">BLE Model : </td><td><span id="device_model"></span></td>
              </tr>
            </tbody>
        </table>
        
      </div>
      <!-- Block -->


    <!-- End Central Column -->
    </div>



  <!-- End Grid -->
  </div>
  <!-- End Row The Grid Device -->










  <!-- The Grid -->
  <div class="w3-row" id="grid_reporter">

    <!-- Left Column -->
    <div class="w3-col m4">

      <!-- Block -->
      <div id="div_reporter_list" class="w3-container w3-card-2 w3-white w3-round w3-margin">

        <h2><span class="glyphicon glyphicon-tag"></span>
        <span id="reporter_list_name">Reporters List</span>&nbsp;<span class="w3-badge w3-green w3-medium" id="reporter_list_nb" style="vertical-align: top;">0</span>
        </h2>
        <input type="hidden" id="reporter_list_id" value="aruba">

        <div class="table-responsive" style="min-height:10px; max-height:400px;">
          <table class="table table-hover">
            <tbody id="tbody_reporter_list">
              <!-- Filled by Javascript -->
            </tbody>
          </table>
        </div>

      </div>
      <!-- Block -->



      <!-- Empty Block pour garder l'espace-->
      <div class="">
        &nbsp;
      </div>
      <!-- Block -->

    <!-- End Left Column -->
    </div>


    <!-- Begin Central Column -->
    <div class="w3-col m8">

      <!-- Block -->
      <div class="w3-container w3-card-2 w3-white w3-round w3-margin" >

        <h2>Reporter "<span id="reporter_name"></span>"</h2>

        <table class="table">
            <tbody>
              <tr>             
        <td align="right" style="width:25%">Status : </td><td><span id="reporter_status"></span></td>
              </tr>
              <tr>             
        <td align="right">Active uptime : </td><td><span id="reporter_uptime"></span></td>
              </tr>
            </tbody>
        </table>

      </div>
      <!-- Block -->

        
      <!-- Block -->
      <div class="w3-container w3-card-2 w3-white w3-round w3-margin" >

        <h3>Properties</h3>
        <table class="table">
            <tbody>
              <tr>             
        <td align="right" style="width:25%">MAC Address : </td><td><span id="reporter_mac"></span></td>
              </tr>
              <tr>             
        <td align="right">Remote IP : </td><td><span id="reporter_remote_ip"></span></td>
              </tr>
              <tr>             
        <td align="right">Local IP : </td><td><span id="reporter_local_ip"></span></td>
              </tr>
              <tr>             
        <td align="right">Hardware Type : </td><td><span id="reporter_hardware_type"></span></td>
              </tr>
              <tr>             
        <td align="right">Software Version : </td><td><span id="reporter_software_version"></span></td>
              </tr>
              <tr>             
        <td align="right">Software Build : </td><td><span id="reporter_software_build"></span></td>
              </tr>
            </tbody>
        </table>
        
      </div>
      <!-- Block -->

      <!-- Block -->
      <div class="w3-container w3-card-2 w3-white w3-round w3-margin" >

        <h3>Websocket Connections</h3>
        <table class="table">
            <tbody>
              <tr>             
        <td align="right" style="width:25%">BLE Connection : </td><td><span id="ap_cnx_ble"></span></td>
              </tr>
              <tr>             
        <td align="right">Zigbee Connection : </td><td><span id="ap_cnx_zigbee"></span></td>
              </tr>
              <tr>             
        <td align="right">Serial Connection : </td><td><span id="ap_cnx_serial"></span></td>
              </tr>
              <tr>             
        <td align="right">WiFi RTLS Connection : </td><td><span id="ap_cnx_rtls"></span></td>
              </tr>
            </tbody>
        </table>
        
      </div>
      <!-- Block -->

      <!-- Empty Block pour garder l'espace-->
      <div class="">
        &nbsp;
      </div>
      <!-- Block -->



    <!-- End Central Column -->
    </div>



  <!-- End Grid -->
  </div>




  
  <!-- The Grid Debug -->
  <div class="w3-row" id="grid_debug">

    <!-- Left Column -->
    <div class="w3-col m12">

      <!-- Block --><!-- AWSS Banner -->
      <div class="w3-container w3-card-2 w3-white w3-round w3-margin" >
 
               <h2>Debug
               <span class="w3-right">
              <button type="button" class="btn btn-warning btn-xs" id="server_cnx_nok" onclick="awss_debug_div_close();">
              Close</button>            
              &nbsp;
              </span></h2>
               <hr>

        <pre id="debug_text">
        </pre>

      </div>
      <!-- Block -->

    </div>
    <!-- End Left Column -->

  </div>
  <!-- End Row The Grid Debug -->




</form>









<!-- Include Modals -->
<div>

<div id="device_overview_modal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
    <form action="#" method="post" class="w3-container">

      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"></button>
        <h2 class="modal-title" id="awss_modal_title">Device</h2>
      </div>
      <div class="modal-body" id="awss_modal_body">

        <div class="well" id="awss_modal_description">
        Service UUID :
        <br>
        Characteristic UUID : 
        </div>

        <label class="w3-text-black"><h4>Characteristic Values</h4> </label>

        <table class="table">
            <tbody>
              <tr>
                <td>
                  <div class="w3-left" id="awss_modal_value_list">
                  </div>
                </td>
              </tr>
            </tbody>
        </table>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal" onclick="awss_modal_close()">Fermer</button>
      </div>
    </form>
    </div>

  </div>
</div>

</div>




<!-- End Page Container -->
</div>
<br>

<!-- Footer -->
<footer class="w3-container w3-theme-d5">

<span class="w3-text-white"><i> Aruba Iot Websocket Server - Demo client v.0.0.1
    - <a href="http://www.phpconcept.net/" target="_blank" class="w3-text-white">
    PhpConcept 2021</a></i>
</span>

</footer>

</body></html>